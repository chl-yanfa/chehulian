<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-datetimepicker.min.css" />
    <link rel="stylesheet" href="../layui/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <link rel="stylesheet" href="../lookpic/dist/zoomify.min.css" />
    <script src="../js/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.bootstrap.min.js"></script>
    <script src="../js/dropdown.js" type="text/javascript"></script>
    <script src="../js/modal.js" type="text/javascript"></script>
    <script type="text/javascript" src="../layui/layui.js"></script>
    <script src="../lookpic/dist/zoomify.min.js"></script>

    <title>车报废管理系统-整车报废</title>
</head>
<body class="bg">
    <div class="topbar">
        <div class="pull-right text-primary" id="loginout" style="margin-left:20px;cursor:pointer;" onclick="loginout()">退出</div>
        <div class="pull-right text-primary" id="loginusername" style="margin-left:20px;"></div>
        <div class="pull-right text-primary" id="loginphonenum"></div>
        <div class="logo"><img src="../img/logo.png" title="" /></div>
        <div class="topcity pull-left">
            <div class="m-b-20">
                <span class="text-primary firstcity pull-left m-r-10 m-l-15"></span>
                <input type="hidden" value="" id="firstcityid" />
                <div class="dropdown pull-left">
                    <div id="changecity" class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        [ 切换城市 <span class="caret"></span> ]
                    </div>
                    <ul class="dropdown-menu" aria-labelledby="changecity"></ul>
                </div>
                <div class="clearfix"></div>
            </div>
            <ul class="nav nav-pills topnav">
                <li role="presentation"><a href="index.html">首页</a></li>
                <li role="presentation" class="kzper1" style="display:none;"><a href="scraplist.html">整车报废</a></li>
                <li role="presentation" class="active kzper2" style="display:none;"><a href="reclaimlist.html">旧件回收</a></li>
                <li role="presentation"><a href="partstrading.html">配件交易</a></li>
                <li role="presentation"><a href="auctionhouse.html">拍卖大厅</a></li>
                <li role="presentation"><a href="questions.html">常见问题</a></li>
                <li role="presentation"><a href="aboutus.html">关于我们</a></li>
                <li role="presentation"><a href="mycenter.html">个人中心</a></li>
            </ul>
        </div>
    </div>
    <div class="formbox">
        <div class="tablebox">
            <ol class="breadcrumb">
                <li><a href="reclaimlist.html">旧件回收</a></li>
                <li class="active">订单详情</li>
            </ol>
            <div class="row">
                <!--车辆信息-->
                <div class="col-md-6">
                    <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 车辆信息</h4>
                    <table class="tablelist">
                        <tr>
                            <th width="120" class="text-right">订单编号：</th>
                            <td><span class="ordnum"></span></td>
                        </tr>
                        <tr id="trcarnumid">
                            <th width="120" class="text-right">车牌号：</th>
                            <td><span class="carnum"></span></td>
                        </tr>
                        <tr>
                            <th width="120" class="text-right">车架号：</th>
                            <td><span class="carjia"></span></td>
                        </tr>
                        <tr>
                            <th width="120" class="text-right">车辆型号：</th>
                            <td><span class="carxing"></span></td>
                        </tr>
                        <tr id="trcarbaoid">
                            <th width="120" class="text-right">报案号：</th>
                            <td><span class="bao"></span></td>
                        </tr>
                        <tr>
                            <th width="120" class="text-right">残值金额：</th>
                            <td><span class="canmoney"></span></td>
                        </tr>
                    </table>
                </div>
                <!--end 车辆信息-->
                <!--取车信息-->
                <div class="col-md-6">
                    <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 取车信息</h4>
                    <table class="tablelist">
                        <tr>
                            <th width="120" class="text-right">取车联系人：</th>
                            <td><span class="carman"></span></td>
                        </tr>
                        <tr>
                            <th width="120" class="text-right">联系人电话：</th>
                            <td><span class="carphone"></span></td>
                        </tr>

                        <tr>
                            <th width="120" class="text-right">取车时间：</th>
                            <td><span class="cartime"></span></td>
                        </tr>
                        <tr>
                            <th width="120" class="text-right">取车地址：</th>
                            <td><span class="caraddress"></span></td>
                        </tr>
                        <!--<tr>
                            <th width="120" class="text-right">取车地址：</th>
                            <td>北京市朝阳区望京SOHOA座</td>
                        </tr>-->
                        <tr>
                            <td></td>
                            <td>
                                <h5 class="pull-left m-r-20">当前进度：<span class="du"></span></h5>
                                <button type="button" class="btn btn-default pull-left" data-toggle="modal" data-target="#myModal">查看进度详情</button>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="clearfix"></div>
                <!--end 取车信息-->
                <div class="col-lg-12">
                    <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件信息</h4>
                    <table class="table  showtab">
                        <thead>
                            <tr>
                                <th width="120">配件分类</th>
                                <th width="120">配件名称</th>
                                <th width="120">零件编号</th>
                                <th width="100px">描述</th>
                                <th width="10%">备注</th>
                                <th width="30%">配件照片</th>
                                <th width="100">残值金额</th>
                                <th width="150">取回时间</th>
                                <th width="80">处置方式</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="page-header"></div>
            <div class="text-center m-b-20"><button class="btn btn-default btn-lg goback">返回</button></div>
        </div>
    </div>
    <!-- 进度详情 -->
    <div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">进度详情</h4>
                </div>
                <div class="modal-body">
                    <div class="">
                        <table class="tablelist">
                            <tr>
                                <th width="120" class="text-right">车牌号：</th>
                                <td><span class="j-carnum"></span></td>
                            </tr>
                            <tr>
                                <th width="120" class="text-right">车架号：</th>
                                <td><span class="j-carjia"></span></td>
                            </tr>
                            <tr>
                                <th width="120" class="text-right">车辆型号：</th>
                                <td><span class="j-carxing"></span></td>
                            </tr>
                            <tr>
                                <th width="120" class="text-right">配件数量：</th>
                                <td><span class="j-carshu"></span></td>
                            </tr>
                        </table>
                    </div>
                    <!--流程图-->
                    <div class="process">
                        <div class="processbox2">
                            <ul>
                                <li class='qiu1'><span class="circular">1</span><p>提交信息<!--:<span class="j-carinfo"></span>--></p></li>
                                <li class="qiu2"><span class="circular">2</span><p>上门取件 <!--<span class="j-time"></span>  取件人：<span class="j-ren"></span>--></p></li>
                                <li class="qiu3"><span class="circular">3</span><p>发放残值款<!--：<span class="j-tai"></span>--></p></li>
                            </ul>
                        </div>
                        <div style="padding-top:50px;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-warning progress-bar-striped" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width:0;">
                                </div>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                    <!--end 流程图-->
                </div>
                <div class="modal-footer" style="margin-top:13px;">
                    <button type="button" class="btn btn-default" data-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>
    <div class="hide">
        <div id="peijian">
            <!--配件信息-->
            <div class="m-b-20">
                <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件信息</h4>
                <table class="tablelist">
                    <tr>
                        <th width="120" class="text-right"><span class="redcolor">*</span>配件分类：</th>
                        <td>
                            <select class="form-control" id="m-lei"></select>
                        </td>
                    </tr>
                    <tr>
                        <th width="120" class="text-right"><span class="redcolor">*</span>配件名称：</th>
                        <td>
                            <select class="form-control" id="m-name"></select>
                        </td>
                    </tr>
                    <tr>
                        <th width="120" class="text-right">零件编号：</th>
                        <td><input class="form-control num" placeholder="" required="" autofocus="" type="text" /></td>
                    </tr>
                    <tr>
                        <th width="120" class="text-right">备注：</th>
                        <td><textarea class="form-control bei" rows="3"></textarea></td>
                    </tr>
                </table>
            </div>
            <!--end 配件信息-->
            <div class="m-b-20">
                <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件照片</h4>
                <div class="row">
                    <div class="col-xs-4 col-md-4">
                        <div class="thumbnail img-input-box">
                            <img src="../img/addimg-bg.png" alt="" onclick="addactpic()" />
                            <form enctype="multipart/form-data" method="post">
                                <input style="display: none;" type="file" name="upload" class="upload2" onchange="doUpload2()" />
                            </form>
                        </div>
                    </div>
                    <div class="cunpic" style="clear: both;">

                    </div>

                </div>
            </div>
        </div>
    </div>
    <script src="../js/comm.js"></script>
    <script type="text/javascript">
        (function ($) {
            if (localStorage.userType == 1) {
                $("#trcarnumid").hide();
                $("#trcarbaoid").hide();
            }
            $.getUrlParam = function (name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return unescape(r[2]);
                return null;
            }
        })(jQuery);
        var id = $.getUrlParam('id');
        function st(x) {
            if (x == 1) {
                x = "待接单 "
            };
            if (x == 2) {
                x = "待回收 "
            };
            if (x == 3) {
                x = "待入库"
            };
            if (x == 4) {
                x = "无法接收 "
            };
            if (x == 5) {
                x = "待结算"
            };
            if (x == 6) {
                x = "待结算"
            };
            if (x == 7) {
                x = "部分结算"
            };
            if (x == 8) {
                x = "已完成"
            };
            if (x == 9) {
                x = "异常"
            };
            return x;
        };
        //获取进度条
        $.ajax({
            type: "get",
            url: href + 'order/getOrderAuditInfo/' + id,
            dataType: "json",
            success: function (data) {
                if (data.msg == "success") {
                    var d = data.data;
                    $(".j-carnum").html(d.carNumber);
                    $(".j-carjia").html(d.carFrameNumber);
                    $(".j-carxing").html(d.carModelNumber);
                    $(".j-carshu").html(d.partsCount);
                    //$(".j-carinfo").html(d.orderTime);
                    //$(".j-time").html(d.receiveOrderTime);
                    //$(".j-ren").html(d.recipient);
                    if (d.orderStatus == 1) {
                        $(".progress-bar-warning").css("width", "20%");
                        $(".qiu1").addClass("finish")
                    };
                    if (d.orderStatus == 3) {
                        $(".progress-bar-warning").css("width", "50%");
                        $(".qiu1").addClass("finish");
                        $(".qiu2").addClass("finish")
                    };
                    if (d.orderStatus == 8) {
                        $(".progress-bar-warning").css("width", "100%");
                        $(".qiu1").addClass("finish");
                        $(".qiu2").addClass("finish");
                        $(".qiu3").addClass("finish")
                    };
                    //$(".j-tai").html(st(d.orderStatus))
                }
            }
        })
        $.ajax({
            type: "get",
            url: href + 'order/' + id,
            dataType: "json",
            success: function (data) {
                if (data.msg == "success") {
                    var d = data.data;
                    $(".ordnum").html(d.orderNo);
                    $(".carnum").html(d.carNumber);
                    $(".carjia").html(d.carFrameNumber);
                    $(".carxing").html(d.carModelNumber);
                    $(".bao").html(d.reportNo);
                    $(".du").html(st(d.orderStatus));
                    $(".carman").html(d.takeCarContacts);
                    $(".carphone").html(d.takeCarContactNumber);
                    $(".cartime").html(d.takeCarTime);
                    $(".caraddress").html(d.takeCarAddress);
                    var dd = d.carScrapOrderAutopartsList;
                    var amount = 0;
                    if (dd.length) {
                        var otr = "";
                        for (var i = 0; i < dd.length; i++) {
                            amount += dd[i].amount;
                            otr += '<tr>'
                            otr += '<td>' + dd[i].partsCaregoryName + '</td>'
                            otr += '<td>' + dd[i].partsTypeName + '</td>'
                            otr += '<td>' + dd[i].partsNum + '</td>'
                            var _miaoshu = "";
                            if (dd[i].isDismantle == "Y") {
                                _miaoshu = _miaoshu + "、纯拆";
                            }
                            if (dd[i].isCollision == "Y") {
                                _miaoshu = _miaoshu + "、碰撞";
                            }
                            if (dd[i].isWear == "Y") {
                                _miaoshu = _miaoshu + "、自然磨损";
                            }
                            if (dd[i].isFlood == "Y") {
                                _miaoshu = _miaoshu + "、水淹";
                            }
                            if (_miaoshu != "")
                                _miaoshu = _miaoshu.substring(1);
                            otr += '<td>' + _miaoshu + '</td>';
                            otr += '<td>' + dd[i].remark + '</td>';
                            var pics = dd[i].autoPartsPictures;
                            var obj = "";
                            var urls = [], ids = [];
                            if (pics.length) {
                                for (var j = 0; j < pics.length; j++) {
                                    urls.push(pics[j].url);
                                    ids.push(pics[j].id)
                                    obj += '<div>'
                                    obj += '<div ><img class="img-rounded" style="float:left;width:120px;height:90px;margin-left:10px" src="' + pics[j].url + '" /></div>'
                                    obj += '</div>'
                                }
                            };
                            var urrs = urls.join();
                            var idss = ids.join();
                            otr += '<td> <div class="row">' + obj + '</div></td>'
                            otr += '<td>' + dd[i].amount + '</td>';
                            otr += '<td>' + dd[i].receiveTime + '</td>'
                            if (dd[i].sortingState==51) {
                                otr += '<td>再制造<br></td>';
                            } else if (dd[i].sortingState == 52) {
                                otr += '<td><a style="color:blue;" href="fittings.html?id=' + dd[i].id + '">处置资料</a></td>';
                            } else {
                                otr += '<td>未知<br></td>';
                            }
                            //otr += '<td>' + dd[i].sortingState + '这里接口没有说明</td>';
                            otr += '</tr>';
                            //                      otr += '<td><a data-id="'+dd[i].id+'" data-ids="'+idss+'" data-url="'+urrs+'" data-bei="'+dd[i].remark+'" data-num="'+dd[i].partsNum+'" data-name="'+dd[i].partsType+'" data-lei="'+dd[i].partsCaregoryId+'" role="button" class="btn btn-default btn-sm bian"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>编辑 </a>'
                            //                      if(dd[i].orderStatus==1){
                            //                    otr += '<button data-id="'+dd[i].id+'" onclick="deldata(this)" type="button" class="btn btn-default btn-sm" ><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除 </button></td></tr>'
                            //                      }else{
                            //                     otr += '</td></tr>'
                            //                      }

                        };
                        $(".canmoney").html(amount.toFixed(2) + "  元");
                        $(".showtab tbody").html(otr);
                        for (var i = 0; i < $(".showtab td").length; i++) {
                            if ($(".showtab td").eq(i).text() == null || $(".showtab td").eq(i).text() == "null") {
                                $(".showtab td").eq(i).html("")
                            }
                        }
                        //初始化话图片
                        $(".showtab tbody  img").zoomify();
                    }
                }
            }
        });
        //编辑配件
        $(document).delegate('.bian', 'click', function (event) {
            event.preventDefault();
            var num = $(this).attr("data-num");
            var bei = $(this).attr("data-bei");
            var leis = $(this).attr("data-lei");
            var name = $(this).attr("data-name");
            var urls = $(this).attr("data-url");
            var ids = $(this).attr("data-ids");
            var oid = $(this).attr("data-id")
            var arrpic = urls.split(",");
            var idjoins = ids.split(",");
            var tt = $(this).parent().parent();
            lei(leis);
            qibie(leis, name);
            $(".num").val(num);
            $(".bei").val(bei);
            var otr = "";
            if (arrpic.length) {
                for (var i = 0; i < arrpic.length; i++) {
                    otr += '<div class="col-xs-4 col-md-4 addpic" data-id="' + idjoins[i] + '" data-url="' + arrpic[i] + '">'
                    otr += '<div class="thumbnail">'
                    otr += '<img src="' + arrpic[i] + '" alt="" />'
                    otr += '<button type="button" class="del-btn"><span onclick="del(this)" class="glyphicon glyphicon-remove"></span></button>'
                    otr += '</div></div>'
                }
            };
            $(".cunpic").html(otr)
            $('#peijian').dialog({
                title: '编辑配件',
                onClose: function () {
                    $(this).dialog('close');
                },
                buttons: [{
                    text: '取消',
                    'click': function () {
                        $(this).dialog('close');
                    }
                }, {
                    text: '确定',
                    'class': 'btn-primary',
                    'click': function () {
                        var otr = ""
                        otr += '<td>' + $('#m-lei option:selected').val() + '</td>'
                        otr += '<td>' + $('#m-name option:selected').val() + '</td>'
                        otr += '<td>' + $(".num").val() + '</td>'
                        otr += '<td>' + $(".bei").val() + '</td>'
                        if ($(".addpic").length) {
                            var obj = "";
                            var urls = [], idss = [];
                            for (var i = 0; i < $(".addpic").length; i++) {
                                urls.push($(".addpic").eq(i).attr("data-url"));
                                idss.push($(".addpic").eq(i).attr("data-id"))
                                obj += '<div class="col-md-3 col-xs-6">'
                                obj += '<div class="thumbnail"><img src="' + $(".addpic").eq(i).attr("data-url") + '" /></div>'
                                obj += '</div>'
                            }
                        }
                        otr += '<td> <div class="row">' + obj + '</div></td>'
                        otr += '<td><a data-id="' + oid + '" data-ids="' + idss.join() + '" data-url="' + urls.join() + '" data-bei="' + $(".bei").val() + '" data-num="' + $(".num").val() + '" data-name="' + $('#m-name option:selected').data('type') + '" data-lei="' + $('#m-lei option:selected').data('type') + '" role="button" class="btn btn-default btn-sm bian"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>编辑 </a>'
                        otr += '<button type="button" onclick="deldata(this)" class="btn btn-default btn-sm" ><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除 </button></td>'
                        tt.html(otr);
                        $('#peijian').dialog('close');
                    }
                }]
            })
        });
        //配件分类
        function lei(x) {
            $.ajax({
                type: "get",
                url: href + "dictionary/getAll",
                data: {
                    sessionid: ""
                },
                dataType: "json",
                success: function (data) {
                    var otr = '';
                    var d = data.data;
                    if (d.length) {
                        for (var i = 0; i < d.length; i++) {
                            otr += '<option data-type="' + d[i].id + '">' + d[i].partsCategoryName + '</option>'
                        };
                        $("#m-lei").html('<option data-type="">请选择配件分类</option>' + otr);
                        //						$("#m-name").html('<option data-type="">请选择配件名称</option>');
                        $("#m-lei option[data-type='" + x + "']").prop("selected", true);
                    } else {
                        $("#m-lei").html('<option data-type="">请选择配件分类</option>');
                        $("#m-name").html('<option data-type="">请选择配件名称</option>');
                    }
                }
            });
        }
        //配件名称变化
        function qibie(id, y) {
            $.ajax({
                type: "get",
                url: href + "dictionary/getByCategoryId",
                data: {
                    categoryId: id
                },
                dataType: "json",
                success: function (data) {
                    var otr = '';
                    var d = data.data;
                    if (d.length) {
                        for (var i = 0; i < d.length; i++) {
                            otr += '<option data-type="' + d[i].id + '">' + d[i].partsName + '</option>'
                        };
                        console.log(otr)
                        $("#m-name").html(otr);
                        $("#m-name option[data-type='" + y + "']").prop("selected", true);
                    } else {
                        $("#m-name").html('<option data-type="">请选择配件名称</option>');
                    }
                }
            });
        };
        //监听配件类型的变化
        $('#m-lei').on('change', function (event) {
            event.preventDefault();
            var id = $('#m-lei option:selected').data('type');
            if (id == "") {
                $("#m-lei").html('<option data-type="">请选择配件分类</option>');
                $("#m-name").html('<option data-type="">请选择配件名称</option>');
            } else {
                qibie(id, "")
            }
        })

        //上传图片
        function doUpload2() {
            var formData = new FormData();
            if ($(".upload2")[0].files.length == 0) {
                alert("请选择pc母版！");
                return false;
            };
            formData.append("files", $(".upload2")[0].files[0]);
            $.ajax({
                url: href2+"upload/attachmet",
                type: "POST",
                data: formData,
                dataType: "json",
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    var otr = ""
                    if (data.msg == "success") {
                        if (data.data.length) {
                            for (var i = 0; i < data.data.length; i++) {
                                otr += '<div class="col-xs-4 col-md-4 addpic" data-id="' + data.data[i].id + '" data-url="' + data.data[i].url + '">'
                                otr += '<div class="thumbnail">'
                                otr += '<img src="' + data.data[i].url + '" alt="" />'
                                otr += '<button type="button" class="del-btn"><span onclick="del(this)" class="glyphicon glyphicon-remove"></span></button>'
                                otr += '</div></div>'
                            }
                        }

                    };
                    $(".cunpic").append(otr)
                },
                error: function (returndata) {
                    alert("操作失败");
                }
            });
        };
        //点击添加图片
        function addactpic() {
            $(".upload2").get(0).click();
        }
        //删除图片
        function del(x) {
            $(x).parent().parent().parent().remove()
        }
        //删除列表数据
        function deldata(x) {
            var id = $(this).attr("data-id");
            var t = $(x).parent().parent();
            $.ajax({
                type: "DELETE",
                url: href + "autoparts/" + id,
                dataType: 'json',
                success: function (data) {
                    if (data.msg == "success") {
                        layer.msg('<span style="font-size:20px">删除成功</span>', {
                            time: 1000, //2s后自动关闭
                        }, function () {
                            window.location.reload()
                        });
                    }
                }

            });

        }
        //返回
        $(".goback").on("click", function (event) {
            event.preventDefault();
            window.history.go(-1)
        });

    </script>
</body>
</html>

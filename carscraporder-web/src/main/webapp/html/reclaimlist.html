<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
    <link rel="stylesheet" href="../layui/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <script src="../js/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.bootstrap.min.js"></script>
    <script src="../js/dropdown.js" type="text/javascript"></script>
    <script src="../layui/layui.js"></script>
    <title>车报废管理系统-旧件回收</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        a {
            text-decoration: none;
        }

            a:hover {
                text-decoration: none;
            }

        .tcdPageCode {
            padding: 15px 20px;
            text-align: left;
            color: #ccc;
            text-align: center;
        }

            .tcdPageCode a {
                display: inline-block;
                color: #428bca;
                display: inline-block;
                height: 25px;
                line-height: 25px;
                padding: 0 10px;
                border: 1px solid #ddd;
                margin: 0 2px;
                border-radius: 4px;
                vertical-align: middle;
            }

                .tcdPageCode a:hover {
                    text-decoration: none;
                    border: 1px solid #428bca;
                }

            .tcdPageCode span.current {
                display: inline-block;
                height: 25px;
                line-height: 25px;
                padding: 0 10px;
                margin: 0 2px;
                color: #fff;
                background-color: #428bca;
                border: 1px solid #428bca;
                border-radius: 4px;
                vertical-align: middle;
            }

            .tcdPageCode span.disabled {
                display: inline-block;
                height: 25px;
                line-height: 25px;
                padding: 0 10px;
                margin: 0 2px;
                color: #bfbfbf;
                background: #f2f2f2;
                border: 1px solid #bfbfbf;
                border-radius: 4px;
                vertical-align: middle;
            }

        .tijia {
            display: inline-block;
            width: 100px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
        /*.table-striped>tbody>tr:nth-of-type(odd) {
                background-color: #f9f9f9;
                opacity: 0.5;
            }*/
    </style>
    <script type="text/javascript">
        //$('.dropdown-toggle').dropdown()
    </script>
</head>
<body class="bg">
    <div class="topbar">
        <div class="pull-right text-primary" id="loginout" style="margin-left:20px;cursor:pointer;" onclick="loginout()">退出</div>
        <div class="pull-right text-primary" id="loginusername" style="margin-left:20px;"></div>
        <div class="pull-right text-primary" id="loginphonenum"></div>
        <div class="logo"><img src="../img/logo.png" title="" /></div>
        <div class="topcity pull-left">
            <div class="m-b-20">
                <span class="text-primary firstcity pull-left m-r-10 m-l-15"></span>
                <input type="hidden" value="" id="firstcityid" />
                <div class="dropdown pull-left">
                    <div id="changecity" class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        [ 切换城市 <span class="caret"></span> ]
                    </div>
                    <ul class="dropdown-menu" aria-labelledby="changecity"></ul>
                </div>
                <div class="clearfix"></div>
            </div>
            <ul class="nav nav-pills topnav">
                <li role="presentation"><a href="index.html">首页</a></li>
                <li role="presentation" class="kzper1" style="display:none;"><a href="scraplist.html">整车报废</a></li>
                <li role="presentation" class="active kzper2" style="display:none;"><a href="reclaimlist.html">旧件回收</a></li>
                <li role="presentation"><a href="partstrading.html">配件交易</a></li>
                <li role="presentation"><a href="auctionhouse.html">拍卖大厅</a></li>
                <li role="presentation"><a href="questions.html">常见问题</a></li>
                <li role="presentation"><a href="aboutus.html">关于我们</a></li>
                <li role="presentation"><a href="mycenter.html">个人中心</a></li>
            </ul>
        </div>
    </div>
    <div class="con-box">
        <div class="tablebox">
            <ol class="breadcrumb">
                <li><a href="reclaimlist.html">旧件回收</a></li>
                <li class="active">订单管理</li>
            </ol>
            <div class="searchbox">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" id="searchval" class="form-control" placeholder="订单编号/车牌号/车架号/描述/联系人/联系电话" />
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" id="searbtn" style="background: #337ab7;color: #fff;padding: 8px 10px;">搜索</button>
                        </span>
                    </div>
                </div>
                <div class="pull-right m-r-20"><a href="reclaim.html" class="btn btn-primary">+ 新订单</a></div>
                <div class="clearfix"></div>
            </div>
            <div class="form-nav-left btn-group-vertical" role="group" aria-label="">
                <button type="button" class="btn btn-default" style="margin-left: 0;">订单管理</button>
                <button type="button" class="btn btn-default topei active">配件查询</button>
            </div>
        </div>
        <div class="formbox-right">
            <div class="tablebox">
                <ul class="nav nav-tabs">
                    <li role="presentation" class="active"><a href="#" data-type="" class="changeye">全部</a></li>
                    <li id="WaitQuoteID" role="presentation"><a href="#" data-type="11,12" class="changeye">待报价</a></li>
                    <li id="AlreadyQuoteID" role="presentation"><a href="#" data-type="13" class="changeye">已报价</a></li>
                    <li role="presentation"><a href="#" data-type="1" class="changeye">未接单</a></li>
                    <li role="presentation"><a href="#" data-type="2" class="changeye">等待取回</a></li>
                    <li role="presentation"><a href="#" data-type="5" class="changeye">等待出库</a></li>
                    <li role="presentation"><a href="#" data-type="3,5,6,7" class="changeye">等待结算</a></li>
                    <li role="presentation"><a href="#" data-type="8" class="changeye">已完成</a></li>
                    <li role="presentation"><a href="#" data-type="4,9" class="changeye">异常订单</a></li>
                </ul>
                <div class="">
                    <table class="table tdmain">
                        <thead>
                            <tr>
                                <th width="80" style="text-align:center;vertical-align:middle;">车牌号</th>
                                <th width="160" style="text-align:center;vertical-align:middle;">订单时间</th>
                                <th width="80" style="text-align:center;vertical-align:middle;">报案号</th>
                                <th width="80" style="text-align:center;vertical-align:middle;">车架号</th>
                                <th width="100" style="text-align:center;vertical-align:middle;">车辆型号</th>
                                <th width="60" style="text-align:center;vertical-align:middle;">数量</th>
                                <th width="60" style="text-align:center;vertical-align:middle;">已接收</th>
                                <th width="80" style="text-align:center;vertical-align:middle;">结算价格</th>
                                <th width="80" style="text-align:center;vertical-align:middle;">状态</th>
                                <th width="140" style="text-align:center;vertical-align:middle;">编辑</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="page" style="background: #fff;">
                        <div class="tcdPageCode"></div>
                    </div>

                    <br /><br /><br />
                </div>
            </div>
        </div>
    </div>


    <div class="hide">
        <div id="shan">
            确定删除吗？
        </div>
    </div>
    <script src="../js/modal.js" type="text/javascript"></script>
    <script src="../js/jquery.page.js"></script>
    <script src="../js/comm.js"></script>
    <script>
        (function ($) {
            if (localStorage.userType != 1) {
                $("#WaitQuoteID").hide();
                $("#AlreadyQuoteID").hide();
            }
        })(jQuery);
        layui.use('layer', function () {

        })

        var typedata = "";
        //点击切换数据
        $(".changeye").on("click", function (event) {
            event.preventDefault();
            $(this).parent().siblings().removeClass("active");
            $(this).parent().addClass("active");
            var type = $(this).attr("data-type");
            var val = $("#searchval").val();
            showdata(1, type, val);
        });
        $("#searbtn").on("click", function (event) {
            event.preventDefault();
            //var type=$(this).attr("data-type");
            var val = $("#searchval").val();
            showdata(1, typedata, val);
        });
        function showdata(x, y, z) {
            typedata = y;
            console.log(JSON.stringify({
                page: x,
                rows: 10,
                orderStatus: y,
                orderType: 2,
                keyWord: z
            }));
            $.ajax({
                type: "get",
                url: href + "order",
                data: {
                    page: x,
                    rows: 10,
                    orderStatus: y,
                    orderType: 2,
                    keyWord: z
                },
                contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    if (data.code == 201) {
                        //delCookie('TT_TICKET');
                        console.log(data);
                        //console.log("接口返回失败，Code:" + 201);
                        //window.location.href = "index.html";
                    }
                    if (data.msg == "success") {
                        var otr = "";
                        var d = data.data.rows;
                        if (d.length) {
                            for (var i = 0; i < d.length; i++) {
                                otr += '<tr>'
                                otr += '<td style="text-align:center;vertical-align:middle;" title="' + d[i].carNumber +'">' + d[i].carNumber + '</td>'
                                otr += '<td style="text-align:center;vertical-align:middle;" title="' + d[i].orderTime +'">' + d[i].orderTime + '</td>'
                                otr += '<td style="text-align:center;vertical-align:middle;" title="' + d[i].reportNo +'">' + d[i].reportNo + '</td>'
                                otr += '<td style="text-align:center;vertical-align:middle;" title="' + d[i].carFrameNumber + '">' + OverLength(d[i].carFrameNumber,16)+ '</td>'
                                otr += '<td style="text-align:center;vertical-align:middle;"><span title="' + d[i].carModelNumberName + '" class="tijia">' + OverLength(d[i].carModelNumberName, 12) + '</span></td>'
                                otr += '<td style="text-align:center;vertical-align:middle;" title="' + d[i].totalPartsCount +'">' + d[i].totalPartsCount + '</td>'
                                otr += '<td style="text-align:center;vertical-align:middle;" title="' + d[i].receivedCount +'">' + d[i].receivedCount + '</td>'
                                otr += '<td style="text-align:center;vertical-align:middle;" title="' + d[i].orderAmount + '">' + d[i].orderAmount + '</td>'
                                otr += '<td style="text-align:center;vertical-align:middle;" title="' + d[i].orderStatus + '">' + GetStateMsg(d[i].orderStatus) + '</td>'
                                otr += '<td style="text-align:center;vertical-align:middle;">'
                                otr += '<button role="button" class="btn btn-default btn-sm cha" data-id="' + d[i].id + '" >'
                                otr += '<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>&nbsp;查看 </button>'
                                if (d[i].orderStatus == 1) {
                                    otr += '<button type="button" class="btn btn-default btn-sm shan" data-id="' + d[i].id + '">'
                                    otr += '<span class="glyphicon glyphicon-remove"  ></span>&nbsp;删除</button>'
                                }
                                else if (d[i].orderStatus == 13){
                                    otr += '<button type="button" class="btn btn-default btn-sm jiage" data-id="' + d[i].id + '">'
                                    otr += '<span class="glyphicon"  ></span>&nbsp;确定价格</button>'
                                }
                                otr += '</td></tr>'
                            }
                        } else {
                            otr = '<tr><td colspan=' + $(".tdmain th").length + ' style="text-align:center">无数据</td></tr>'
                        }
                        $(".tdmain tbody").html(otr);
                        for (var i = 0; i < $(".tdmain td").length; i++) {
                            if ($(".tdmain td").eq(i).text() == null || $(".tdmain td").eq(i).text() == "null") {
                                $(".tdmain td").eq(i).html("")
                            }
                        }
                        $(".page").html("");
                        $(".page").html('<div class="tcdPageCode"></div>');
                        $(".tcdPageCode").createPage({
                            pageCount: Math.ceil(data.data.total / 10),
                            current: x,
                            backFn: function (p) {
                                showdata2(p, y, z)
                            }
                        });
                    }

                }

            });
        };
        function showdata2(x, y, z) {
            typedata = y;
            $.ajax({
                type: "get",
                url: href + "order",
                data: {
                    page: x,
                    rows: 10,
                    orderStatus: y,
                    orderType: 2,
                    keyWord: z
                },
                contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    if (data.code == 201) {
                        delCookie('TT_TICKET');
                        console.log(data);
                        //window.location.href = "index.html"
                    }
                    if (data.msg == "success") {
                        var otr = "";
                        var d = data.data.rows;
                        if (d.length) {
                            for (var i = 0; i < d.length; i++) {
                                otr += '<tr>'
                                otr += '<td title="' + d[i].carNumber+'">' + d[i].carNumber + '</td>'
                                otr += '<td title="' + d[i].orderTime +'">' + d[i].orderTime + '</td>'
                                otr += '<td title="' + d[i].reportNo +'">' + d[i].reportNo + '</td>'
                                otr += '<td title="' + d[i].carFrameNumber + '">' + OverLength(d[i].carFrameNumber,16) + '</td>'
                                otr += '<td><span title="' + d[i].carModelNumberName + '" class="tijia">' + OverLength(d[i].carModelNumberName, 12) + '</span></td>'
                                otr += '<td title="' + d[i].totalPartsCount +'">' + d[i].totalPartsCount + '</td>'
                                otr += '<td title="' + d[i].receivedCount +'">' + d[i].receivedCount + '</td>'
                                otr += '<td title="' + d[i].amount +'">' + d[i].amount + '</td>'
                                otr += '<td title="' + d[i].orderStatus + '">' + GetStateMsg(d[i].orderStatus) + '</td>'
                                otr += '<td>'
                                otr += '<button role="button" class="btn btn-default btn-sm cha" data-id="' + d[i].id + '" >'
                                otr += '<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>查看 </button>'
                                if (d[i].orderStatus == 1) {
                                    otr += '<button type="button" class="btn btn-default btn-sm shan" data-id="' + d[i].id + '">'
                                    otr += '<span class="glyphicon glyphicon-remove"  ></span>删除</button>'
                                }
                                else if (d[i].orderStatus == 13) {
                                    otr += '<button type="button" class="btn btn-default btn-sm jiage" data-id="' + d[i].id + '">'
                                    otr += '<span class="glyphicon"  ></span>&nbsp;确定价格</button>'
                                }
                                otr += '</td></tr>'
                            }
                        } else {
                            otr = '<tr><td colspan=' + $(".tdmain th").length + ' style="text-align:center">无数据</td></tr>'
                        }
                        $(".tdmain tbody").html(otr);
                        for (var i = 0; i < $(".tdmain td").length; i++) {
                            if ($(".tdmain td").eq(i).text() == null || $(".tdmain td").eq(i).text() == "null") {
                                $(".tdmain td").eq(i).html("")
                            }
                        }
                        $(".page").html("");
                        $(".page").html('<div class="tcdPageCode"></div>');
                        $(".tcdPageCode").createPage({
                            pageCount: Math.ceil(data.data.total / 10),
                            current: x,
                            backFn: function (p) {
                                showdata(p, y, z)
                            }
                        });
                    }

                }

            });
        }

        function OverLength(a, b) {
            var result = a;
            if (a) {
                if (a.length>b) {
                    result = a.substring(0, b) + "...";
                }
            }
            return result;
        }

        showdata(1, "", "");
        //判断状态
        function st(x) {
            if (x == 1) {
                x = "待接单 "
            };
            if (x == 2) {
                x = "待回收 "
            };
            if (x == 3) {
                x = "待入库"
            };
            if (x == 4) {
                x = "无法接收 "
            };
            if (x == 5) {
                x = "待结算"
            };
            if (x == 6) {
                x = "待结算"
            };
            if (x == 7) {
                x = "部分结算"
            };
            if (x == 8) {
                x = "已完成"
            };
            if (x == 9) {
                x = "异常"
            };
            return x;
        };
        //查看
        $(document).delegate('.cha', 'click', function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            window.location.href = "reclaim-de.html?id=" + id
        })
        //查看
        $(document).delegate('.jiage', 'click', function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            window.location.href = "confirmprice.html?id=" + id
        })
        //配件上查询
        $(document).delegate('.topei', 'click', function (event) {
            event.preventDefault();
            window.location.href = "paretlist.html";
        })
        //删除
        $(document).delegate('.shan', 'click', function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            $('#shan').dialog({
                title: '删除',
                onClose: function () {
                    $(this).dialog('close');
                },
                buttons: [{
                    text: '取消',
                    'click': function () {
                        $(this).dialog('close');
                    }
                }, {
                    text: '确定',
                    'class': 'btn-primary',
                    'click': function () {
                        $.ajax({
                            type: "DELETE",
                            url: href + "order/" + id,
                            dataType: 'json',
                            success: function (data) {
                                if (data.msg == "success") {
                                    layer.msg('<span style="font-size:20px">删除成功</span>', {
                                        time: 1000, //2s后自动关闭
                                    }, function () {
                                        window.location.reload()
                                    });
                                }
                            }

                        });
                    }
                }]
            })
        });
    </script>
</body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-datetimepicker.min.css" />
    <link rel="stylesheet" href="../layui/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <link rel="stylesheet" href="../lookpic/dist/zoomify.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/pagination.css" />
    <script src="../js/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.bootstrap.min.js"></script>
    <script src="../js/dropdown.js" type="text/javascript"></script>
    <script src="../js/modal.js" type="text/javascript"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=3LSsiAvyTOStAaAc4Nwb2EDyZcUc9lx8"></script>
    <script type="text/javascript" src="../layui/layui.js"></script>
    <script src="../lookpic/dist/zoomify.min.js"></script>
    <script type="text/javascript" src="../js/pagination.js"></script>
    <script src="../js/template-web.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .datetimepicker {
            margin-top: 50px !important;
        }

        #r-result {
            width: 100%;
        }

        .tangram-suggestion {
            z-index: 9999;
        }

        #addrenwrapper a {
            border-radius: 5px;
        }

        .paginationjs-pages {
            margin-left: 35%;
        }
    </style>
    <!--<script src="js/datetimepicker/bootstrap-datetimepicker.min.js" type="text/javascript"></script>-->
    <title>车互联-旧件回收—新订单</title>
</head>
<body class="bg" style="background-color:#fff;">
    <div class="topbar">
        <div class="pull-right text-primary" id="loginout" style="margin-left:20px;cursor:pointer;" onclick="loginout()">退出</div>
        <div class="pull-right text-primary" id="loginusername" style="margin-left:20px;"></div>
        <div class="pull-right text-primary" id="loginphonenum"></div>
        <div class="logo"><img src="../img/logo.png" title="" /></div>
        <div class="topcity pull-left">
            <div class="m-b-20">
                <span class="text-primary firstcity pull-left m-r-10 m-l-15"></span>
                <input type="hidden" value="" id="firstcityid" />
                <div class="dropdown pull-left">
                    <div id="changecity" class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        [ 切换城市 <span class="caret"></span> ]
                    </div>
                    <ul class="dropdown-menu" aria-labelledby="changecity"></ul>
                </div>
                <div class="clearfix"></div>
            </div>
            <ul class="nav nav-pills topnav">
                <li role="presentation"><a href="index.html">首页</a></li>
                <li role="presentation" class="kzper1" style="display:none;"><a href="scraplist.html">整车报废</a></li>
                <li role="presentation" class="active kzper2" style="display:none;"><a href="reclaimlist.html">旧件回收</a></li>
                <li role="presentation"><a href="partstrading.html">配件交易</a></li>
                <li role="presentation"><a href="auctionhouse.html">拍卖大厅</a></li>
                <li role="presentation"><a href="questions.html">常见问题</a></li>
                <li role="presentation"><a href="aboutus.html">关于我们</a></li>
                <li role="presentation"><a href="mycenter.html">个人中心</a></li>
            </ul>
        </div>
    </div>
    <div class="tablebox">
        <div class="form-nav-left btn-group-vertical" role="group" aria-label="" style="z-index: 1;">
            <button type="button" class="btn btn-defaul" style="margin-left: 0;"><a href="reclaimlist.html">订单管理</a></button>
            <button type="button" class="btn btn-default active"><a href="paretlist.html">配件查询</a></button>
        </div>
    </div>
    <div class="formbox-right">
        <div class="tablebox">
            <ol class="breadcrumb">
                <li><a href="reclaimlist.html">旧件回收</a></li>
                <li><a href="reclaimlist.html">订单管理</a></li>
                <li class="active">添加订单</li>
            </ol>
            <div class="row">
                <!--车辆信息-->
                <div class="col-md-6">
                    <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 车辆信息</h4>
                    <table class="tablelist">
                        <tr id="trcarnumid">
                            <th width="120" class="text-right"><span class="redcolor">*</span>车牌号：</th>
                            <td><input class="form-control carnum" placeholder="" type="text" /></td>
                        </tr>
                        <tr>
                            <th width="120" class="text-right"><span class="redcolor">*</span>车架号：</th>
                            <td><input class="form-control carjia" placeholder="" type="text" /></td>
                        </tr>
                        <tr>
                            <th width="120" class="text-right"><span class="redcolor">*</span>车辆型号：</th>
                            <td><input class="form-control carxing" disabled="disabled" placeholder="" type="text" /></td>
                        </tr>
                        <tr id="trcarbaoid">
                            <th width="120" class="text-right"><span class="redcolor">*</span>报案号：</th>
                            <td><input class="form-control carbao" placeholder="" type="text" /></td>
                        </tr>
                    </table>
                </div>
                <!--end 车辆信息-->
                <!--取车信息-->
                <div class="col-md-6">
                    <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 取件信息</h4>
                    <table class="tablelist">
                        <tr>
                            <th width="120" class="text-right"><span class="redcolor">*</span>取件联系人：</th>
                            <td>
                                <div class="input-group">
                                    <input type="text" id="changren" class="form-control" placeholder="" />
                                    <span class="input-group-btn">
                                        <button class="btn btn-default quan" type="button">常用联系人</button>
                                    </span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th width="120" class="text-right"><span class="redcolor">*</span>联系人电话：</th>
                            <td><input class="form-control perphone" placeholder="" required="" autofocus="" type="text" /></td>
                        </tr>

                        <tr>
                            <th width="120" class="text-right"><span class="redcolor">*</span>取件时间：</th>
                            <td>
                                <div class="input-group">
                                    <input type="text" readonly="readonly" class="form-control" id="checktime" placeholder="" />
                                    <!--<span role="button"  class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>-->
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th width="120" class="text-right"><span class="redcolor">*</span>取件地址：</th>
                            <td><input class="form-control setmap" placeholder="" required="" autofocus="" type="text" /></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>您当前选择的城市为<i class="text-primary" id="onlycity">北京</i>，取车地址只能为<span id="onlycityspan">北京</span>。</td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>
                                <label>
                                    <input type="checkbox" id="setcommonperson" /> 将该联系人设置为常用联系人
                                </label>
                            </td>
                        </tr>
                    </table>
                </div>
                <!--end 取车信息-->
                <!--配件信息-->
                <div class="clearfix"></div>
                <div>
                    <div class="page-header">
                        <h4 class="pull-left"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件信息</h4>
                        <button type="button" class="btn btn-primary pull-right peibtn">+ 添加配件</button>
                        <div class="clearfix"></div>
                    </div>
                    <table class="table table-striped addtab">
                        <thead>
                            <tr>
                                <th>配件分类</th>
                                <th>配件名称</th>
                                <th>零件编号</th>
                                <th>描述</th>
                                <th>备注</th>
                                <th width="40%">配件照片</th>
                                <th>编辑</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!--end 配件信息-->
            </div>
            <div class="page-header"></div>
            <div class="text-center m-b-20"><button class="btn btn-primary btn-lg m-r-20 adddata">提交信息</button><button class="btn btn-default btn-lg goback">返回</button></div>
        </div>
    </div>
    <!-- 常用联系人 -->
    <div class="hide">
        <div id="detailState">
            <table class="table table-striped addren" id="addrenlistinfo">
                <thead><tr><th width="200">姓名</th><th>电话</th></tr></thead>
                <tbody></tbody>
            </table>
            <script id="addrenlisttemp" type="text/html">
                {{each rows value i}}
                <tr>
                    <td><input type="radio" name="con-per" class="dancheck" />{{value.contactName}}</td>
                    <td>{{value.contactTelephone}}</td>
                </tr>
                {{/each}}
            </script>
            <div id="addrenwrapper">

            </div>
        </div>
    </div>
    <div class="hide">
        <input type="hidden" id="coordinate" />
        <div id="showmap" style="z-index:999;">
            <table>
                <tr>
                    <td>
                        <input type="text" id="suggestId" name="Locality" value="" class="form-control"
                               required=required placeholder="请输入车辆所在位置" maxlength="20" style="width:350px;" />
                        <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;z-index:1000;"></div>
                        <div id="l-map" style="width:535px;height:305px;margin-top:10px;margin-left:10px;"></div>

                    </td>
                    <td style="width: 10px;"></td>
                </tr>
            </table>
            <br />
            <div id="allmap"></div>
        </div>
    </div>
    <div class="hide">
        <div id="peijian">
            <!--配件信息-->
            <div class="m-b-20">
                <h4><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件信息</h4>
                <table class="tablelist">
                    <tr>
                        <th width="120" class="text-right"><span class="redcolor">*</span>配件分类：</th>
                        <td>
                            <select class="form-control" id="m-lei"></select>
                        </td>
                    </tr>
                    <tr>
                        <th width="120" class="text-right"><span class="redcolor">*</span>配件名称：</th>
                        <td>
                            <select class="form-control" id="m-name"></select>
                        </td>
                    </tr>
                    <tr>
                        <th width="120" class="text-right">零件编号：</th>
                        <td><input class="form-control num" placeholder="" required="" autofocus="" type="text" /></td>
                    </tr>
                    <tr>
                        <th width="120" class="text-right">备注：</th>
                        <td><textarea class="form-control bei" rows="3"></textarea></td>
                    </tr>
                    <tr>
                        <th width="120" class="text-right">描述：</th>
                        <td>
                            <label style="margin-left:20px;"><input type="checkbox" class="mcheckbox" id="m_chunchai" value="纯拆" /> 纯拆</label>
                            <label style="margin-left:20px;"><input type="checkbox" class="mcheckbox" id="m_pengzhuang" value="碰撞" /> 碰撞</label>
                            <label style="margin-left:20px;"><input type="checkbox" class="mcheckbox" id="m_mosun" value="自然磨损" /> 自然磨损</label>
                            <label style="margin-left:20px;"><input type="checkbox" class="mcheckbox" id="m_shuiyan" value="水淹" /> 水淹</label>
                        </td>
                    </tr>
                </table>
            </div>
            <!--end 配件信息-->
            <div class="m-b-20" s=s>
                <h4 class="page-header" style="margin-top:-15px;"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件照片</h4>
                <div class="row">
                    <div class="cunpic" style="clear: both;">

                    </div>
                    <div class="col-xs-4 col-md-4">
                        <div class="thumbnail img-input-box" id="addfpic">
                            <img title="可添加可拖拽.." src="../img/addimg-bg1.png" alt="" id="addpicsimg" onclick="addactpic()" />
                            <form enctype="multipart/form-data" method="post">
                                <input style="display: none;" type="file" multiple="multiple" accept=".png,.jpg,.jpeg,.gif,.PNG,.JPG,.JPEG,.GIF" name="upload" class="upload2" onchange="doUpload2()" />
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../js/bootstrap-datetimepicker.min.js"></script>
    <script src="../js/bootstrap-datetimepicker.zh-CN.js"></script>
    <script src="../js/comm.js"></script>
    <script>
        (function ($) {
            if (localStorage.userType == 1) {
                $("#trcarnumid").hide();
                $("#trcarbaoid").hide();
            }
        })(jQuery);
        layui.use('layer', function () {

        })
        //常用联系人
        $(document).delegate('.quan', 'click', function (event) {
            event.preventDefault();
            //$.ajax({
            //    type: "get",
            //    url: href + 'commonContacts?page=1&rows=10',
            //    dataType: "json",
            //    success: function (data) {
            //        if (data.msg == "success") {
            //            var d = data.data.rows;
            //            var otr = "";
            //            for (var i = 0; i < d.length; i++) {
            //                otr += '<tr><td><input type="radio" name="con-per"  class="dancheck" >   ' + d[i].contactName + '</td><td>' + d[i].contactTelephone + '</td></tr>'
            //            };
            //            $(".addren tbody").html(otr)
            //        }
            //    }
            //})
            var url = href + "commonContacts";
            PaginationFunc(1, 10, url, "#addrenwrapper", "#addrenlistinfo", "addrenlisttemp");
            $('#detailState').dialog({
                title: '常用联系人',
                onClose: function () {
                    $(this).dialog('close');
                },
                buttons: [{
                    text: '取消',
                    'click': function () {
                        $(this).dialog('close');
                    }
                }, {
                    text: '确定',
                    'class': 'btn-primary',
                    'click': function () {
                        for (var i = 0; i < $(".dancheck").length; i++) {
                            if ($(".dancheck").eq(i).prop("checked") == true) {
                                $("#changren").val($(".dancheck").eq(i).parent().parent().find("td").eq(0).text().trim());
                                $(".perphone").val($(".dancheck").eq(i).parent().parent().find("td").eq(1).text());
                            }
                        }
                        $('#detailState').dialog('close')
                    }
                }]
            })
        });

        //分页公共方法
        function PaginationFunc(page, rows, url, wrappername, tbname, tempid) {
            var arr = [];
            $.ajax({
                type: "get",
                url: url,
                data: {
                    page: page,
                    rows: rows
                },
                dataType: "json",
                success: function (obj) {
                    if (obj.code == "201") {
                        layer.msg('<span style="font-size:20px">登录时效，请重新登录</span>', {
                            time: 1000, //2s后自动关闭
                        }, function () {
                            window.location.href = "login.html";
                        });
                        return false;
                    }
                    if (obj.msg == "success") {
                        var count = obj.data.total;
                        for (var i = 0; i < count; i++) {
                            arr.push(i)
                        }
                        $(wrappername).pagination({
                            dataSource: arr,
                            pageNumber: page,
                            pageSize: rows,
                            prevText: "上一页",
                            nextText: "下一页",
                            callback: function (data, pagination) { //回调函数 当我们点击页数执行的方法
                                LoadList(pagination.pageNumber, rows, url, tbname, tempid);
                            }
                        })
                    }
                }
            });
        }
        function LoadList(page, rows, url, tbname, tempid) {
            $.ajax({
                type: "get",
                url: url,
                data: {
                    page: page,
                    rows: rows
                },
                dataType: "json",
                success: function (obj) {
                    if (obj.code == "201") {
                        layer.msg('<span style="font-size:20px">登录时效，请重新登录</span>', {
                            time: 1000, //2s后自动关闭
                        }, function () {
                            window.location.href = "login.html";
                        });
                        return false;
                    }
                    if (obj.msg == "success") {
                        var count = obj.data.rows;
                        var tbinfo = $(tbname);
                        var showlist = [];
                        if (count == 0) {
                            showlist.push('<tr><td colspan=' + tbinfo.find("th").count + ' style="text-align:center">无数据</td></tr>');
                            tbinfo.find("tbody").html(showlist.join(''));
                        }
                        else {
                            var html = template(tempid, obj.data);
                            tbinfo.find("tbody").html(html);
                        }
                    }
                },
                error: function (ex) {
                    console.log(ex);
                }
            });
        }

        //选择时间
        $('#checktime').datetimepicker({
            format: 'yyyy-mm-dd hh:00:00',
            language: 'zh-CN',
            autoclose: 1,
            minView: "day",
            hoursDisabled: []
        });
        var day3 = new Date();
        day3.setTime(day3.getTime() + 24 * 60 * 60 * 1000);
        var s3 = day3.getFullYear() + "-" + (day3.getMonth() + 1) + "-" + day3.getDate();
        $('#checktime').datetimepicker('setStartDate', s3);
        // 百度地图API功能
        function G(id) {
            return document.getElementById(id);
        }

        var map = new BMap.Map("l-map");
        map.setCurrentCity("北京");
        map.enableScrollWheelZoom();//启动鼠标滚轮缩放地图
        map.centerAndZoom(new BMap.Point(116.4136103013, 39.9110666857), 12);                // 初始化地图,设置城市和地图级别。
        map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
        //单击获取点击的经纬度
        //map.addEventListener("click", function (e) {
        //    alert(e.point.lng + "," + e.point.lat);
        //});
        var geoc = new BMap.Geocoder();
        var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
            {
                "input": "suggestId"
                , "location": map
            });
        map.addEventListener("click", function (e) {
            var pt = e.point;
            $("#coordinate").val(pt.lng + "," + pt.lat);
            geoc.getLocation(pt, function (rs) {
                map.clearOverlays();
                map.addOverlay(new BMap.Marker(pt));
                var addComp = rs.addressComponents;
                $("#suggestId").val(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);

            });
        });
        console.log("ss");
        ac.addEventListener("onhighlight", function (e) {  //鼠标放在下拉列表上的事件
            var str = "";
            var _value = e.fromitem.value;
            var value = "";
            if (e.fromitem.index > -1) {
                value = _value.province + _value.city + _value.district + _value.street + _value.business;
            }
            str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

            value = "";
            if (e.toitem.index > -1) {
                _value = e.toitem.value;
                value = _value.province + _value.city + _value.district + _value.street + _value.business;
            }
            str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
            G("searchResultPanel").innerHTML = str;
        });

        var myValue;
        ac.addEventListener("onconfirm", function (e) {    //鼠标点击下拉列表后的事件
            var _value = e.item.value;
            myValue = _value.province + _value.city + _value.district + _value.street + _value.business;
            G("searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;
            setPlace();
        });

        function setPlace() {
            map.clearOverlays();    //清除地图上所有覆盖物
            function myFun() {
                var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                map.centerAndZoom(pp, 18);
                map.addOverlay(new BMap.Marker(pp));    //添加标注
            }
            var local = new BMap.LocalSearch(map, { //智能搜索
                onSearchComplete: myFun
            });
            local.search(myValue);
        }
        //点击打开地图
        $(document).delegate('.setmap', 'click', function (event) {
            event.preventDefault();
            $('#showmap').dialog({
                title: '取车地址',
                onClose: function () {
                    $(this).dialog('close');
                },
                buttons: [{
                    text: '取消',
                    'click': function () {
                        $(this).dialog('close');
                    }
                }, {
                    text: '确定',
                    'class': 'btn-primary',
                    'click': function () {
                        $(".setmap").val($("#suggestId").val());
                        $('#showmap').dialog('close');

                    }
                }]
            })
            map.centerAndZoom("北京", 11);      // 用城市名设置地图中心点
        });
        //添加配件
        $(document).delegate('.peibtn', 'click', function (event) {
            event.preventDefault();
            lei();
            $(".num").val("");
            $(".bei").val("");
            $(".cunpic").html("");
            $('#peijian').dialog({
                title: '添加配件',
                onClose: function () {
                    $(this).dialog('close');
                },
                buttons: [{
                    text: '取消',
                    'click': function () {
                        $(this).dialog('close');
                    }
                }, {
                    text: '确定',
                    'class': 'btn-primary',
                    'click': function () {
                        if ($('#m-name option:selected').data('type') == "") {
                            layer.msg('<span style="font-size:20px">请选择配件分类</span>', {
                                time: 2000, //2s后自动关闭
                            });
                            return;
                        }
                        var otr = ""
                        otr += '<tr>'
                        otr += '<td>' + $('#m-lei option:selected').val() + '</td>'
                        otr += '<td>' + $('#m-name option:selected').val() + '</td>'
                        otr += '<td>' + $(".num").val() + '</td>'
                        var miaoshu = "";
                        $(".mcheckbox").each(function () {
                            if ($(this).is(':checked')) {
                                miaoshu = miaoshu + "、" + $(this).val();
                            }
                        });
                        if (miaoshu != "")
                            miaoshu = miaoshu.substring(1);
                        otr += '<td>' + miaoshu + '</td>'
                        otr += '<td>' + $(".bei").val() + '</td>'
                        if ($(".addpic").length) {
                            var obj = "";
                            var urls = [], ids = [];
                            //($(".addpic").length > 3 ? 3 : $(".addpic").length)
                            for (var i = 0, t = $(".addpic").length; i < t; i++) {
                                if (i > 2) {
                                    urls.push($(".addpic").eq(i).attr("data-url"));
                                    ids.push($(".addpic").eq(i).attr("data-id"))
                                    obj += '<div style="display:none;" class="col-md-3 col-xs-6">'
                                    obj += '<div class="thumbnail"><img class="img-rounded" style="display:block;width:100%;height:100px" src="' + $(".addpic").eq(i).attr("data-url") + '" /></div>'
                                    obj += '</div>'
                                }
                                else {
                                    urls.push($(".addpic").eq(i).attr("data-url"));
                                    ids.push($(".addpic").eq(i).attr("data-id"))
                                    obj += '<div class="col-md-3 col-xs-6">'
                                    obj += '<div class="thumbnail"><img class="img-rounded" style="display:block;width:100%;height:100px" src="' + $(".addpic").eq(i).attr("data-url") + '" /></div>'
                                    obj += '</div>'
                                }
                            }
                        } else {
                            layer.msg('<span style="font-size:20px">请选择配件照片</span>', {
                                time: 2000, //2s后自动关闭
                            });
                            return;
                        }
                        otr += '<td> <div class="row">' + obj + '</div></td>'
                        otr += '<td><a data-ids="' + ids.join() + '" data-url="' + urls.join() + '" data-bei="' + $(".bei").val() + '" data-num="' + $(".num").val() + '" data-name="' + $('#m-name option:selected').data('type') + '" data-lei="' + $('#m-lei option:selected').data('type') + '"data-miaoshu="' + miaoshu + '"  role="button" class="btn btn-default btn-sm bian"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>编辑 </a>'
                        otr += '<button onclick="deldata(this)" type="button" class="btn btn-default btn-sm" ><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除 </button></td></tr>'

                        $(".addtab tbody").append(otr);
                        //初始化话图片
                        $(".addtab tbody  img").zoomify();
                        $(".mcheckbox").attr("checked", false)
                        $('#peijian').dialog('close');
                    }
                }]
            })
        });
        //编辑配件
        $(document).delegate('.bian', 'click', function (event) {
            event.preventDefault();
            var num = $(this).attr("data-num");
            var bei = $(this).attr("data-bei");
            var leis = $(this).attr("data-lei");
            var name = $(this).attr("data-name");
            var urls = $(this).attr("data-url");
            var ids = $(this).attr("data-ids");
            var miaoshu = $(this).attr("data-miaoshu");
            var arrpic = urls.split(",");
            var idjoins = ids.split(",");
            var tt = $(this).parent().parent();
            lei(leis);
            qibie(leis, name);
            $(".num").val(num);
            $(".bei").val(bei);
            if (miaoshu.indexOf("纯拆") > -1) {
                $("#m_chunchai").prop("checked",true);
            }
            if (miaoshu.indexOf("碰撞") > -1) {
                $("#m_pengzhuang").prop("checked", true);
            }
            if (miaoshu.indexOf("自然磨损") > -1) {
                $("#m_mosun").prop("checked", true);
            }
            if (miaoshu.indexOf("水淹") > -1) {
                $("#m_shuiyan").prop("checked", true);
            }
            var otr = "";
            if (arrpic.length) {
                for (var i = 0; i < arrpic.length; i++) {
                    otr += '<div class="col-xs-4 col-md-4 addpic" data-id="' + idjoins[i] + '" data-url="' + arrpic[i] + '">'
                    otr += '<div class="thumbnail">'
                    otr += '<img style="display:block;width:100%;height:100px" src="' + arrpic[i] + '" alt="" />'
                    otr += '<button type="button" class="del-btn"><span onclick="del(this)" class="glyphicon glyphicon-remove"></span></button>'
                    otr += '</div></div>'
                }
            };
            $(".cunpic").html(otr);
            $('#peijian').dialog({
                title: '编辑配件',
                onClose: function () {
                    $(this).dialog('close');
                },
                buttons: [{
                    text: '取消',
                    'click': function () {
                        $(this).dialog('close');
                    }
                }, {
                    text: '确定',
                    'class': 'btn-primary',
                    'click': function () {
                        var otr = ""
                        otr += '<td>' + $('#m-lei option:selected').val() + '</td>'
                        otr += '<td>' + $('#m-name option:selected').val() + '</td>'
                        otr += '<td>' + $(".num").val() + '</td>'
                        var miaoshu = "";
                        $(".mcheckbox").each(function () {
                            if ($(this).is(':checked')) {
                                miaoshu = miaoshu + "、" + $(this).val();
                            }
                        });
                        if (miaoshu != "")
                            miaoshu = miaoshu.substring(1);
                        otr += '<td>' + miaoshu + '</td>'
                        otr += '<td>' + $(".bei").val() + '</td>'
                        if ($(".addpic").length <= 0) {
                            layer.msg('<span style="font-size:20px">请上传配件照片</span>', {
                                time: 2000, //2s后自动关闭
                            });
                            return;
                        }
                        if ($(".addpic").length) {
                            var obj = "";
                            var urls = [], idss = [];
                            for (var i = 0, t = t = $(".addpic").length; i < t; i++) {
                                if (i > 2) {
                                    urls.push($(".addpic").eq(i).attr("data-url"));
                                    idss.push($(".addpic").eq(i).attr("data-id"))
                                    obj += '<div style="display:none;" class="col-md-3 col-xs-6">'
                                    obj += '<div class="thumbnail"><img  class="img-rounded" style="display:block;width:100%;height:100px" src="' + $(".addpic").eq(i).attr("data-url") + '" /></div>'
                                    obj += '</div>'
                                }
                                else {
                                    urls.push($(".addpic").eq(i).attr("data-url"));
                                    idss.push($(".addpic").eq(i).attr("data-id"))
                                    obj += '<div class="col-md-3 col-xs-6">'
                                    obj += '<div class="thumbnail"><img  class="img-rounded" style="display:block;width:100%;height:100px" src="' + $(".addpic").eq(i).attr("data-url") + '" /></div>'
                                    obj += '</div>'
                                }
                            }
                        }
                        otr += '<td> <div class="row">' + obj + '</div></td>'
                        otr += '<td><a data-ids="' + idss.join() + '" data-url="' + urls.join() + '" data-bei="' + $(".bei").val() + '" data-num="' + $(".num").val() + '" data-name="' + $('#m-name option:selected').data('type') + '" data-lei="' + $('#m-lei option:selected').data('type') + '"data-miaoshu="' + miaoshu + '"  role="button" class="btn btn-default btn-sm bian"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>编辑 </a>'
                        otr += '<button type="button" onclick="deldata(this)" class="btn btn-default btn-sm" ><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除 </button></td>'
                        tt.html(otr);
                        //初始化话图片
                        $(".addtab tbody  img").zoomify();
                        $('#peijian').dialog('close');
                    }
                }]
            })
        });
        //配件分类
        function lei(x) {
            $.ajax({
                type: "get",
                url: href + "dictionary/getAll",
                data: {
                    sessionid: ""
                },
                dataType: "json",
                success: function (data) {
                    var otr = '';
                    var d = data.data;
                    if (d.length) {
                        for (var i = 0; i < d.length; i++) {
                            otr += '<option data-type="' + d[i].id + '">' + d[i].partsCategoryName + '</option>'
                        };
                        $("#m-lei").html('<option data-type="">请选择配件分类</option>' + otr);
                        $("#m-name").html('<option data-type="">请选择配件名称</option>');
                        $("#m-lei option[data-type='" + x + "']").prop("selected", true);
                    } else {
                        $("#m-lei").html('<option data-type="">请选择配件分类</option>');
                        $("#m-name").html('<option data-type="">请选择配件名称</option>');
                    }
                }
            });
        }
        //配件名称变化
        function qibie(id, y) {
            $.ajax({
                type: "get",
                url: href + "dictionary/getByCategoryId",
                data: {
                    categoryId: id
                },
                dataType: "json",
                success: function (data) {
                    var otr = '';
                    var d = data.data;
                    if (d.length) {
                        for (var i = 0; i < d.length; i++) {
                            otr += '<option data-type="' + d[i].id + '">' + d[i].partsName + '</option>'
                        };
                        $("#m-name").html(otr);
                        $("#m-name option[data-type='" + y + "']").prop("selected", true);
                    } else {
                        $("#m-name").html('<option data-type="">请选择配件名称</option>');
                    }
                }
            });
        };
        //监听配件类型的变化
        $('#m-lei').on('change', function (event) {
            event.preventDefault();
            var id = $('#m-lei option:selected').data('type');
            if (id == "") {
                $("#m-lei").html('<option data-type="">请选择配件分类</option>');
                $("#m-name").html('<option data-type="">请选择配件名称</option>');
            } else {
                qibie(id, "")
            }
        })

        //上传图片
        function doUpload2() {
            var lg = $(".upload2")[0].files;
            if (lg.length == 0) {
                alert("请选择pc母版！");
                return false;
            };
            if (lg.length > 6) {
                alert("最多可以上传6张图片！");
                return false;
            }
            for (var i = 0; i < lg.length; i++) {
                var formData = new FormData();
                var pics = lg[i].name;
                if (!/\.(jpg|png|gif|jpeg|JPG|PNG|GIF|JPEG)$/.test(pics)) {
                    alert("请上传正确图片格式");
                    $(".upload2").val("");
                    return;
                };
                var sizes = lg[i].size;
                var pan = Math.round(sizes / 1024 * 100) / 100;
                if (pan > 4096) {
                    alert("所传图片不能大于4M");
                    //$(".upload2").val("");
                    return;
                };
                formData.append("files", lg[i]);
                $.ajax({
                    url: href2 + "/upload/attachmet",
                    type: "POST",
                    data: formData,
                    dataType: "json",
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        //console.log(data);
                        var otr = ""
                        if (data.msg == "success") {
                            if (data.data.length) {
                                for (var i = 0; i < data.data.length; i++) {
                                    otr += '<div class="col-xs-4 col-md-4 addpic" data-id="' + data.data[i].id + '" data-url="' + data.data[i].url + '">'
                                    otr += '<div class="thumbnail">'
                                    otr += '<img style="display:block;width:100%;height:100px" src="' + data.data[i].url + '" alt="" />'
                                    otr += '<button type="button" class="del-btn"><span onclick="del(this)" class="glyphicon glyphicon-remove"></span></button>'
                                    otr += '</div></div>'
                                }
                            }
                        };
                        $(".cunpic").append(otr)
                        if ($(".addpic").length && $(".addpic").length >= 6) {
                            $("#addfpic").hide();
                        }
                    },
                    error: function (returndata) {
                        alert("操作失败");
                    }
                });
            }
        };
        //点击添加图片
        function addactpic() {
            $(".upload2").get(0).click();
        }
        //删除图片
        function del(x) {
            $(x).parent().parent().parent().remove();
            if ($(".addpic").length && $(".addpic").length < 6) {
                $("#addfpic").show();
            }
        }
        //删除列表数据
        function deldata(x) {
            $(x).parent().parent().remove()
        }
        //返回
        $(".goback").on("click", function (event) {
            event.preventDefault();
            window.history.go(-1)
        })
        //数据提交
        $(".adddata").on("click", function (event) {
            event.preventDefault();
            if ($(".carnum").val() == "" && localStorage.userType != 1) {
                layer.msg('<span style="font-size:20px">车牌号不能为空</span>', {
                    time: 2000, //2s后自动关闭
                });
                return;
            };
            if ($(".carjia").val() == "") {
                layer.msg('<span style="font-size:20px">车架号不能为空</span>', {
                    time: 2000, //2s后自动关闭
                });
                return;
            };
            if ($(".carxing").val() == "") {
                layer.msg('<span style="font-size:20px">车型号不能为空</span>', {
                    time: 2000, //2s后自动关闭
                });
                return;
            };
            if ($(".carbao").val() == "" && localStorage.userType != 1) {
                layer.msg('<span style="font-size:20px">报案号不能为空</span>', {
                    time: 2000, //2s后自动关闭
                });
                return;
            };
            if ($("#changren").val() == "") {
                layer.msg('<span style="font-size:20px">取件联系人不能为空</span>', {
                    time: 2000, //2s后自动关闭
                });
                return;
            };
            if ($(".perphone").val() == "") {
                layer.msg('<span style="font-size:20px">取件联系人电话不能为空</span>', {
                    time: 2000, //2s后自动关闭
                });
                return;
            };
            if ($("#checktime").val() == "") {
                layer.msg('<span style="font-size:20px">取件时间不能为空</span>', {
                    time: 2000, //2s后自动关闭
                });
                return;
            }
            else {
                var xiaoshi = parseInt($("#checktime").val().split(' ')[1].split(':')[0]);
                if (xiaoshi < 9 || xiaoshi > 18) {
                    layer.msg('<span style="font-size:20px">取件时间只能在9点-18点之间</span>', {
                        time: 2000, //2s后自动关闭
                    });
                    return;
                }
            };
            var qccity = $(".setmap").val();
            if (qccity == "") {
                layer.msg('<span style="font-size:20px">取件地址不能为空</span>', {
                    time: 2000, //2s后自动关闭
                });
                return;
            } else {
                var onlycity = $("#onlycity").text() + "市";
                if (qccity.indexOf(onlycity) < 0) {
                    layer.msg('<span style="font-size:20px">您当前选择的城市为' + onlycity + '，取车地址只能为' + onlycity + '</span>', {
                        time: 3000, //3s后自动关闭
                    });
                    return;
                }
            };
            var otr1 = [];
            if ($(".bian").length) {
                for (var i = 0; i < $(".bian").length; i++) {
                    var arr = $(".bian").eq(i).attr("data-ids").split(",");
                    var otr2 = [];
                    for (var j = 0; j < arr.length; j++) {
                        otr2.push({
                            attachmentId: arr[j],
                            pritureCategory: 1
                        })
                    }
                    var miaoshu = $(".bian").eq(i).attr("data-miaoshu");
                    otr1.push({
                        pictures: otr2,
                        partsType: $(".bian").eq(i).attr("data-name"),
                        partsNum: $(".bian").eq(i).attr("data-num"),
                        remark: $(".bian").eq(i).attr("data-bei"),
                        isDismantle: miaoshu.indexOf("纯拆") > -1 ? "Y" : "",
                        isCollision: miaoshu.indexOf("碰撞") > -1 ? "Y" : "",
                        isWear: miaoshu.indexOf("自然磨损") > -1 ? "Y" : "",
                        isFlood: miaoshu.indexOf("水淹") > -1 ? "Y" : ""
                    })
                }
            };
            console.log(JSON.stringify({
                carNumber: $(".carnum").val(),
                carFrameNumber: $(".carjia").val(),
                carModelNumber: $(".carxing").val(),
                orderType: 2,
                takeCarContacts: $("#changren").val(),
                takeCarContactNumber: $(".perphone").val(),
                takeCarTime: $("#checktime").val(),
                takeCarAddress: $(".setmap").val(),
                coordinate: $("#coordinate").val(),
                reportNo: $(".carbao").val(),
                isSetUpContacts: $("#setcommonperson")[0].checked,
                carScrapOrderAutopartsList: otr1
            }));
            //return;
            $.ajax({
                type: "post",
                url: href + "order",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    carNumber: $(".carnum").val(),
                    carFrameNumber: $(".carjia").val(),
                    carModelNumber: $(".carxing").val(),
                    orderType: 2,
                    takeCarContacts: $("#changren").val(),
                    takeCarContactNumber: $(".perphone").val(),
                    takeCarTime: $("#checktime").val(),
                    takeCarAddress: $(".setmap").val(),
                    coordinate: $("#coordinate").val(),
                    reportNo: $(".carbao").val(),
                    isSetUpContacts: $("#setcommonperson")[0].checked,
                    carScrapOrderAutopartsList: otr1
                }),
                dataType: "json",
                success: function (data) {
                    if (data.code == "201") {
                        layer.msg('<span style="font-size:20px">登录时效，请重新登录</span>', {
                            time: 1000, //2s后自动关闭
                        }, function () {
                            window.location.href = "login.html";
                        });
                        return false;
                    }
                    if (data.msg == "success") {
                        layer.msg('<span style="font-size:20px">订单提交成功</span>', {
                            time: 1000, //2s后自动关闭
                        }, function () {
                            window.location.href = "reclaimlist.html"
                        });


                    }
                }
            });
        });
        //根据车架号查询车型名称
        $(".carjia").on("blur", function () {
            if ($(".carjia").val()) {
                var index = layer.msg('<span style="font-size:20px">数据加载中</span>', {
                });
                $.ajax({
                    type: "get",
                    url: href + "carModel?vin=" + $(".carjia").val(),
                    dataType: "json",
                    success: function (data) {
                        if (data.code == "201") {
                            layer.msg('<span style="font-size:20px">登录时效，请重新登录</span>', {
                                time: 1000, //2s后自动关闭
                            }, function () {
                                window.location.href = "login.html";
                            });
                            return false;
                        }
                        if (data.msg == "success") {
                            layer.close(index);
                            if (data.data == "" || data.data == null) {
                                $(".carxing").val("");
                                $(".carxing").attr("placeholder", '车辆型号无法识别，请自行填写')
                                $(".carxing").attr("disabled", false)
                            } else {
                                $(".carxing").attr("disabled", "disabled");
                                $(".carxing").val(data.data)
                            }

                        }
                    }
                });
            }
            else {
                $(".carxing").attr("placeholder", '');
                $(".carxing").attr("disabled", "disabled");
                $(".carxing").val("");
            }
        })

        DragPicture();
        function DragPicture() {
            var box = document.getElementById("addpicsimg");
            box.ondragover = function (e) {
                e.preventDefault();
            }
            box.ondrop = function (e) {
                e.preventDefault();
                if (e.dataTransfer.files.length > 6) {
                    alert("最多可以上传6张图片！");
                    return false;
                }
                for (var i = 0; i < e.dataTransfer.files.length; i++) {
                    var f = e.dataTransfer.files[i];//获取到第一个上传的文件对象
                    var path = f.name;
                    var extStart = path.lastIndexOf('.');
                    var ext = path.substring(extStart, path.length).toUpperCase();
                    if (ext !== '.PNG' && ext !== '.JPG' && ext !== '.JPEG' && ext !== '.GIF') {
                        layer.alert("请上传正确格式的图片！");
                        return false;
                    } else {
                        var formData = new FormData();
                        formData.append('files', f);
                        $.ajax({
                            url: href2 + "/upload/attachmet",
                            type: "POST",
                            data: formData,
                            async: false,
                            cache: false,
                            contentType: false,
                            processData: false,
                            dataType: "json",
                            success: function (data) {
                                console.log(data);
                                var otr = ""
                                if (data.code == "201") {
                                    layer.msg('<span style="font-size:20px">登录时效，请重新登录</span>', {
                                        time: 1000, //2s后自动关闭
                                    }, function () {
                                        window.location.href = "login.html";
                                    });
                                    return false;
                                }
                                if (data.msg == "success") {
                                    if (data.data.length) {
                                        for (var i = 0; i < data.data.length; i++) {
                                            otr += '<div class="col-xs-4 col-md-4 addpic" data-id="' + data.data[i].id + '" data-url="' + data.data[i].url + '">'
                                            otr += '<div class="thumbnail">'
                                            otr += '<img style="display:block;width:100%;height:100px" src="' + data.data[i].url + '" alt="" />'
                                            otr += '<button type="button" class="del-btn"><span onclick="del(this)" class="glyphicon glyphicon-remove"></span></button>'
                                            otr += '</div></div>'
                                        }
                                    }
                                };
                                $(".cunpic").append(otr)
                                if ($(".addpic").length && $(".addpic").length >= 6) {
                                    $("#addfpic").hide();
                                }
                            },
                            error: function (e) {
                                alert("操作失败" + e);
                            }
                        });
                    }
                }
            }
        }
    </script>
</body>
</html>